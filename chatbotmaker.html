<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Bubble Example</title>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.3/dist/tailwind.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />

    <style>



            

        /* Bubble for toggling chat */
        #chatbot-bubble.chatbot-bubble {
        all: unset;
        z-index: 1000;
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 1px solid;
        background-color: #ffffff;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
        }

        #chatbot-bubble.chatbot-bubble img {
        width: 30px;
        height: 30px;
        }

        #chatbot-bubble.chatbot-bubble:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Chat container */
        #chat-container.chat-container {
        all: unset;
        z-index: 1000;
        position: fixed;
        bottom: 108px;
        right: 30px;
        width: 345px;
        height: 325px;
        border-radius: 10px;
        background-color: white;
        border: 1px solid;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: none;
        flex-direction: column;
        padding: 0.9rem;
        }

        #chat-container.chat-container:after {
        content: '';
        position: absolute;
        bottom: -18px;
        right: 10px;
        width: 0;
        height: 0;
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        /* border-top: 20px solid white; */
        }

        /* Chatbox container */
        #chat-container.chat-container .chatbox {
        all: unset;
        display: flex;
        flex-direction: column;
        background-color: #f7fafc;
        height: calc(100% - 80px);
        padding: 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        gap: 1rem;
        overflow-y: auto;
        scrollbar-width: auto;
        scrollbar-color: rgb(139, 139, 139) transparent;
        }

        .message-bot {
        background-color: rgb(255, 255, 255);
        color: rgb(255, 255, 255);
        border: 1px solid rgb(0, 0, 0); 
        align-self: flex-start;
        }

        .message-user {
        background-color: rgb(255, 255, 255);
        color: rgb(255, 255, 255);
        border: 1px solid rgb(0, 0, 0);
        align-self: flex-end;
        }

        .message-element {
        font-size: 15px;
        font-weight: 200;
        padding: 16px;
        border-radius: 8px;
        max-width: 250px;
        box-shadow: 0px 10px 15px -3px rgba(0, 0, 0, 0.1), 0px 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Fixed message bar at the bottom */
        #chat-container.chat-container .message-bar {
        all: unset;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        margin-left: 5px;
        margin-right: 5px;
        padding-left: 1.1rem;
        padding-right: 1rem;
        padding-bottom: 0.5rem;
        padding-top: 50px;
        margin-top: 20px;
        display: flex;
        align-items: center;
        background-color: transparent;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0);
        }

        /* Input field for messages */
        #chat-container.chat-container .message-bar .message-input {
        all: unset;
        flex-grow: 1;
        border: 1px solid rgb(209, 213, 219);
        padding: 0.70rem;
        margin-left: -7px;
        margin-right: 0.5rem;
        outline: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 15px;
        transition: border-color 0.2s;
        --tw-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
        border-width: 1px;
        border-radius: .5rem;
        box-sizing: border-box;
        -webkit-text-size-adjust: 100%;
        }

        #chat-container.chat-container .message-bar .message-input:focus {
        border-color: #b4b3ff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Send button styling */
        #chat-container.chat-container .message-bar .send-button {
        all: unset;
        margin-left: 0.75rem;
        margin-right: -5px;
        padding: 0.6rem 0.9rem;
        transition: all 0.3s ease-in-out;
        display: block;
        font-size: 0.9rem;
        font-weight: bold;
        color: #ffffff;
        background-color: #000000;
        border: none;
        cursor: pointer;
        --tw-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
        border-radius: .5rem;
        }

        #chat-container.chat-container .message-bar .send-button:hover {
        background-color: rgb(196, 196, 196);
        transform: scale(1.05);
        }

        #chat-container.chat-container .message-bar .send-button:focus {
        transform: scale(1.07);
        }




        :root {
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #4AC4F3;
            background-image: url('img/gg.jpg');
            background-repeat: no-repeat;
            background-size: cover;
            color: #111827;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            max-width: 500px;
            width: 100%;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: #1f2937;
            font-size: 1.875rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4b5563;
        }

        input,
        textarea {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: #f9fafb;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        textarea {
            height: 120px;
            resize: none;
        }

        input[type="color"] {
            padding: 0;
            border: none;
            height: 40px;
            width: 100%;
            background-color: transparent;
            cursor: pointer;
        }

        #create {
            display: block;
            width: 100%;
            padding: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: #ffffff;
            background-color: #3b82f6;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1.5rem;
        }

        #create:hover {
            background-color: #2563eb;
        }





        #json-output {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            /* Keeps formatting in JSON */
        }





        #myIframe {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }


              /* Add this to your CSS file or within a <style> tag in your HTML */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(0, 38, 255); /* Semi-transparent grey background */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            display: none; /* Hide container by default */
            z-index: 10000; /* Place loader above everything */
        }
        
        .loader {
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            z-index: 10001; /* Place loader above everything */
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }


    </style>


</head>

<body>


  
        
    
    <div id="form-container" class="container">
        <h1>Bot-In ChatBot Maker</h1>
        <div class="form-group">
            <label for="company">Company:</label>
            <input type="text" id="company" placeholder="Enter company name">
        </div>

        <div class="form-group">
            <label for="companywebsite">Company WebSite:</label>
            <input type="url" id="companywebsite"
                placeholder="Enter your company website">
        </div>

        <div class="form-group">
            <label for="companyemail">Company Email:</label>
            <input type="email" id="companyemail" placeholder="Enter company email">
        </div>

        <div class="form-group">
            <label for="companyemailcc">Company Email CC:</label>
            <input type="email" id="companyemailcc" placeholder="Enter company email CC">
        </div>

        <div class="form-group">
            <label for="chatbotname">Chatbot Name:</label>
            <input type="text" id="chatbotname" placeholder="Enter chatbot name">
        </div>
        <div class="form-group">
            <label for="welcome">Welcome Message:</label>
            <textarea id="welcome" rows="2" placeholder="Enter welcome message"></textarea>
        </div>
        <div class="form-group" style="display: none;">
            <label for="companydata">Company Data:</label>
            <textarea id="companydata" rows="4" placeholder="Enter company data"></textarea>
        </div>

        <div class="form-group">
            <label for="bubblecolor">bubble Color:</label>
            <input type="color" id="bubblecolor">
        </div>

        <div class="form-group">
            <label for="chatcolor">Chat Color:</label>
            <input type="color" id="chatcolor">
        </div>
        <div class="form-group">
            <label for="bgcolor">Background Color:</label>
            <input type="color" id="bgcolor">
        </div>
        <div class="form-group">
            <label for="inputcolor">Input Color:</label>
            <input type="color" id="inputcolor">
        </div>
        <div class="form-group">
            <label for="buttoncolor">Button Color:</label>
            <input type="color" id="buttoncolor">
        </div>
        <div class="form-group">
            <label for="botcolor">Bot Color:</label>
            <input type="color" id="botcolor">
        </div>
        <div class="form-group">
            <label for="usercolor">User Color:</label>
            <input type="color" id="usercolor">
        </div>
        <br>
        <br>
        <button id="create">Create Chatbot</button>
        <pre hidden id="json-output"></pre>
    </div>


    <div class="loader-container">
        <div id="loader" class="loader"></div><br>
        <h1 style="color: white; margin-top: -18px;">Creating Your Bot-In Chatbot ...</h1>
    </div>



    <div class="chatbot-bubble" id="chatbot-bubble" style="visibility: hidden;">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/chat.png" id="chat-icon" alt="Chatbot">
    </div>

    <div id="chat-container" class="chat-container">
        <div id="chatbox" class="chatbox"></div>
        <div class="message-bar">
            <input class="message-input" id="messageInput" type="text" placeholder="Type your question here..." />
            <button class="send-button" type="button" id="sendButton">Ask</button>
        </div>
    </div>


    <iframe id="myIframe"></iframe>

 

</body>


   <script>



        const createjson = () => {

            //document.getElementById('json-output').textContent = jsonString;
            // const blob = new Blob([jsonString], { type: 'application/json' });
            // const url = URL.createObjectURL(blob);
            // const a = document.createElement('a');
            // a.href = url;
            // a.download = 'data.json';
            // a.click();
            // URL.revokeObjectURL(url);
            return jsonString;
        };

        var loader = document.getElementById("loader");


        function showLoader() {
            loader.style.display = "block";
            document.querySelector('.loader-container').style.display = 'flex';
        }

        function hideLoader() {
            loader.style.display = "none";
            document.querySelector('.loader-container').style.display = 'none';
        }

        document.getElementById('create').addEventListener('click', () => {

            magic();
        });


        async function magic() {


            const company = document.getElementById('company').value.trim();
            const companyemail = document.getElementById('companyemail').value.trim();
            const companyemailcc = document.getElementById('companyemailcc').value.trim();
            const chatbotname = document.getElementById('chatbotname').value.trim();
            const welcome = document.getElementById('welcome').value.trim();
            var companydata = document.getElementById('companydata').value.trim();
            const chatcolor = document.getElementById('chatcolor').value.trim();
            const bgcolor = document.getElementById('bgcolor').value.trim();
            const inputcolor = document.getElementById('inputcolor').value.trim();
            const buttoncolor = document.getElementById('buttoncolor').value.trim();
            const botcolor = document.getElementById('botcolor').value.trim();
            const usercolor = document.getElementById('usercolor').value.trim();
            const bubblecolor = document.getElementById('bubblecolor').value.trim();
            const companywebsite = document.getElementById('companywebsite').value.trim();




            if (!company || !companyemail || !companyemailcc || !chatbotname || !welcome ) {
                alert('Please fill in all fields.');
                return;
            }


            const url = companywebsite;
            const resultContainer = document.getElementById('companydata');

      try {
        // Make the API request
        const response = await fetch(`https://api-scraper-nine.vercel.app/api/scrape?url=${encodeURIComponent(url)}`);

        if (!response.ok) {
          throw new Error('Failed to scrape the website. Make sure the URL is correct.');
        }

        const data = await response.json();

        const parser = new DOMParser();
        const doc = parser.parseFromString(data.html, 'text/html');

        // Remove all <script> and <style> elements
        const scripts = doc.querySelectorAll('script');
        scripts.forEach(script => script.remove());

        const styles = doc.querySelectorAll('style');
        styles.forEach(style => style.remove());
        
        // Remove all spaces
        doc.body.innerHTML = doc.body.innerHTML.replace(/\s+/g, ' ');

        // Extract text content
        const textContent = doc.body.textContent || 'No text content found.';

        if (data.html) {
          // Display the scraped HTML in the <pre> element
            resultContainer.textContent = textContent;
            console.log(textContent);
        } else {
          resultContainer.textContent = 'No HTML found. Please try a different URL.';
        }
      } catch (error) {
        resultContainer.textContent = `Error: ${error.message}`;
      }

      companydata = document.getElementById('companydata').value.trim();
           

            
            showLoader(); // show the loader
            setTimeout(hideLoader, 10000); // Hide the loader after 10s



           


            document.getElementById('form-container').style.display = 'none';
            document.getElementById('chatbot-bubble').style.visibility = 'visible';
            var link = document.getElementById('companywebsite').value;

            if (!link) {
                link = "page.html";
            }
            
            document.getElementById("myIframe").style.display = "block";
            document.getElementById("myIframe").src = link;






            const jsonObject = {
                company,
                companyemail,
                companyemailcc,
                chatbotname,
                welcome,
                companydata,
                chatcolor,
                bgcolor,
                inputcolor,
                buttoncolor,
                botcolor,
                usercolor,
                bubblecolor
            };

            const jsonString = JSON.stringify(jsonObject, null, 2);




            // console.log("USER DATA");
            // console.log(company);
            // console.log(companyemail);
            // console.log(companyemailcc);
            // console.log(chatbotname);
            // console.log(welcome);
            // console.log(companydata);
            // console.log(chatcolor);
            // console.log(bgcolor);
            // console.log(inputcolor);
            // console.log(buttoncolor);
            // console.log(botcolor);
            // console.log(usercolor);
            // console.log(bubblecolor);






            function invertColor(hex, bw) {
                if (hex.indexOf('#') === 0) {
                    hex = hex.slice(1);
                }
                // convert 3-digit hex to 6-digits.
                if (hex.length === 3) {
                    hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
                }
                if (hex.length !== 6) {
                    throw new Error('Invalid HEX color.');
                }
                var r = parseInt(hex.slice(0, 2), 16),
                    g = parseInt(hex.slice(2, 4), 16),
                    b = parseInt(hex.slice(4, 6), 16);

                if (bw) {
                    return (r * 0.299 + g * 0.587 + b * 0.114) > 186
                        ? '#000000'
                        : '#FFFFFF';
                }

                // invert color components
                r = (255 - r).toString(16);
                g = (255 - g).toString(16);
                b = (255 - b).toString(16);
                // pad each with zeros and return
                return "#" + padZero(r) + padZero(g) + padZero(b) + 30;
            }

            function padZero(str, len) {
                len = len || 2;
                var zeros = new Array(len).join('0');
                return (zeros + str).slice(-len);
            }


            const chatContainer = document.getElementById('chat-container');
            const chatIcon = document.getElementById('chat-icon');



            document.getElementById("sendButton").style.backgroundColor = buttoncolor;
            document.getElementById("sendButton").style.color = invertColor(buttoncolor, true);
            document.getElementById("messageInput").style.color = invertColor(inputcolor, true);
            document.getElementById("messageInput").style.backgroundColor = inputcolor;
            document.getElementById("chatbox").style.backgroundColor = chatcolor;
            document.getElementById("chat-container").style.backgroundColor = bgcolor;
            document.getElementById("chat-container").style.borderColor = invertColor(bgcolor, false);
            document.getElementById("chatbot-bubble").style.backgroundColor = bubblecolor;
            document.getElementById("chatbot-bubble").style.borderColor = invertColor(bubblecolor, false);
            document.getElementById("chat-icon").style.color = invertColor(bubblecolor, true);



                const srcX = 'https://img.icons8.com/?size=100&id=46&format=png&color=' + invertColor(bubblecolor, true).substring(1);
                const srcB = 'https://img.icons8.com/ios-filled/50/' + invertColor(bubblecolor, true).substring(1) + '/chat.png';


                if (chatContainer.style.display === 'none' || chatContainer.style.display === '') {
                chatIcon.src = srcB; // Chat icon
            } else {
                chatIcon.src = srcX; // Close icon
            }







            // chatContainer.style.display = 'none';
            // chatIcon.src = srcX; // Chat icon
            // chatIcon.src = srcB; // Chat icon





            const chatbox = document.getElementById("chatbox");

            const chatId = crypto.randomUUID();

            let receiving = false;

            let responseText = "";

            let websocketResponse = "";


            function createMessageElement(text, alignment) {
                const messageElement = document.createElement("div");
                messageElement.style.color = alignment === "left" ? invertColor(botcolor, true) : invertColor(usercolor, true);
                messageElement.style.border = alignment === "left" ? `1px solid ${invertColor(botcolor, false)}` : `1px solid ${invertColor(usercolor, false)}`;
                messageElement.style.backgroundColor = alignment === "left" ? botcolor : usercolor;
                messageElement.className = `p-4 rounded-lg max-w-xs ${alignment === "left" ? `message-bot` : "message-user"
                    } ${alignment === "left" ? "self-start" : "self-end"} shadow-xl`;
                messageElement.textContent = text;
                return messageElement;
            }




            function connectWebSocket(systemPrompt, message, task) {
                return new Promise((resolve, reject) => {

                    receiving = true;
                    const url = "wss://backend.buildpicoapps.com/api/chatbot/chat";
                    const websocket = new WebSocket(url);

                    websocket.addEventListener("open", () => {
                        websocket.send(
                            JSON.stringify({
                                chatId: chatId,
                                appId: "keep-physical",
                                systemPrompt: systemPrompt,
                                message: message,
                            })
                        );
                    });

                    const messageElement = createMessageElement("", "left");
                    chatbox.appendChild(messageElement);



                    let responseText = "";

                    websocket.onmessage = (event) => {
                        responseText += event.data; // Append incoming data to responseText
                        messageElement.textContent = responseText;
                        chatbox.scrollTop = chatbox.scrollHeight;
                    };

                    websocket.onclose = (event) => {
                        if (event.code === 1000) {
                            receiving = false;
                            resolve(responseText); // Resolve the promise with the final response
                        } else {
                            messageElement.textContent += "Error getting response from server. Refresh the page and try again.";
                            chatbox.scrollTop = chatbox.scrollHeight;
                            receiving = false;
                            reject(new Error("WebSocket closed with an error"));
                        }
                    };

                    websocket.onerror = (error) => {
                        receiving = false;
                        reject(error); // Reject the promise on error
                    };
                });
            }

            messageInput.addEventListener("keydown", (event) => {
                if (
                    event.key === "Enter" &&
                    !receiving &&
                    messageInput.value.trim() !== ""
                ) {
                    event.preventDefault();
                    sendButton.click();
                }
            });

            function welcomeMessageFirstTime(message) {
                const welcomeMessage = message;
                const messageElement = createMessageElement(welcomeMessage, "left");
                chatbox.appendChild(messageElement);

            }





            welcomeMessageFirstTime(welcome);




            const sendButton = document.getElementById("sendButton");

            sendButton.addEventListener("click", async function () {
                const messageInput = document.getElementById("messageInput");
                const userInput = messageInput.value;
                const prompt = `TASK: if someone asks you anything, your task is to classify the Request in the frame of these given functions: (C= "User asking to Contact the company or he is interested to get one of our products or services ", G= "general info", S= "support ticket if the user have any issue or problem or need help", D= "if the user did input all his data for rdv or Contact", R= "if the user want to do a meet or need an appointement or a rdv or need to see us") and then return response that just looks like this : X , focus on the response form that should be ONLY the letter alone , this X is a variable that can be C, R, D, G or S
        
        User input: ${userInput}`;

                try {
                    const response = await fetch(
                        `https://a.picoapps.xyz/ask-ai?prompt=${encodeURIComponent(prompt)}`
                    );
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    const data = await response.json();
                    // console.log(data.response);





                    if (data.response === "R") {

                        // console.log("rdv");

                        let systemPrompt = `You are an AI chatbot for ${company} That handle RDVs and appointements section by asking questions about details of the appointement in a short simple text paragraphe where you ask about the fullname of the user, the email,the phone number, the subject of rdv, the timing and date of the meet, and if it is online or inplace. and dont use numbers for questions , just ask diectly the question in a simple text form.       `;

                        if (!receiving && messageInput.value.trim() !== "") {
                            const messageText = messageInput.value.trim();
                            messageInput.value = "";
                            const messageElement = createMessageElement(
                                messageText,
                                "right"
                            );
                            chatbox.appendChild(messageElement);
                            chatbox.scrollTop = chatbox.scrollHeight;

                            // Use await to get the response from connectWebSocket
                            websocketResponse = await connectWebSocket(systemPrompt, messageText, "R");
                            // console.log(websocketResponse); // Log the WebSocket response

                        }
                    } else {
                        if (data.response === "C") {
                            // console.log("contact");

                            let systemPrompt = `
            
            You are an AI chatbot for ${company} That handle company communication and contact section by asking questions about details of the message you need to deliver in form of short simple text paragraphe : like the name of the user, the email, the phone number, the subject and the message`;


                            if (!receiving && messageInput.value.trim() !== "") {
                                const messageText = messageInput.value.trim();
                                messageInput.value = "";
                                const messageElement = createMessageElement(
                                    messageText,
                                    "right"
                                );
                                chatbox.appendChild(messageElement);
                                chatbox.scrollTop = chatbox.scrollHeight;
                                // Use await to get the response from connectWebSocket
                                websocketResponse = await connectWebSocket(systemPrompt, messageText, "C");
                                // console.log(websocketResponse); // Log the WebSocket response

                            }
                        } else {
                            if (data.response === "S") {
                                // console.log("support");

                                let systemPrompt = `You are an AI chatbot for ${company} That handle support questions and try to help user by giving them usefull infos that can support them or help them, and always you tell them that the issue was redirected to support office and they have been notified with the user issue . Some of Company Data and contact infos that can help you support the user : 
                ${companydata}
                
            `;


                                if (!receiving && messageInput.value.trim() !== "") {
                                    const messageText = messageInput.value.trim();

                                    const messageElement = createMessageElement(
                                        messageText,
                                        "right"
                                    );
                                    chatbox.appendChild(messageElement);
                                    chatbox.scrollTop = chatbox.scrollHeight;
                                    // Use await to get the response from connectWebSocket
                                    const we = await connectWebSocket(systemPrompt, messageText, "S");


                                    var body = '<br/> >> user message : ' + messageText + '<br/> <br/> <br/> >> chatbot response : ' + we + '<br/> <br/> <br/> <br/> <br/> ';



                                    //MY SMTP API CALL CODE

                                    const isHtml = true;
                                    const response = await fetch('https://mail-api-eight.vercel.app/api/send-email', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            to: companyemail,
                                            cc: companyemailcc,
                                            subject: "Support Request",
                                            message: body,
                                            isHtml: isHtml
                                        })
                                    });

                                    const result = await response.json();

                                    if (response.ok) {
                                        alert(`Notification sent to ${company} Support`);
                                    } else {
                                        alert('Error in sending Mail !!!');
                                    }



                                    messageInput.value = "";

                                }
                            } else {
                                if (data.response === "G") {
                                    // console.log("general");

                                    let systemPrompt = `
            You are ${chatbotname}, an AI chatbot for ${company} and made by ${company}, you only talk about ${company} , if the user ask any other question no related to ${company} you kindly tell him you cant because you are only trained on ${company} data , Ask the user's name and then address them with the name in the conversation. give short well-formatted answers with spaces and jump lines after each question to make the text visually appealing and focus on giving short summerized answers, and only talk in subjects related to ${company} and you never say you are developed by OpenAI or you are based on the GPT, you always say ${company} made you.  
            Some of Company general Data :${companydata}`;

                                    if (!receiving && messageInput.value.trim() !== "") {
                                        const messageText = messageInput.value.trim();
                                        messageInput.value = "";
                                        const messageElement = createMessageElement(
                                            messageText,
                                            "right"
                                        );
                                        chatbox.appendChild(messageElement);
                                        chatbox.scrollTop = chatbox.scrollHeight;

                                        // Use await to get the response from connectWebSocket
                                        const web = await connectWebSocket(systemPrompt, messageText, "G");

                                    }

                                } else {
                                    if (data.response === "D") {
                                        // console.log("SMTP");


                                        if (messageInput.value.trim() !== "") {
                                            const messageText = messageInput.value.trim();
                                            const messageElement = createMessageElement(
                                                messageText,
                                                "right"
                                            );
                                            chatbox.appendChild(messageElement);
                                            chatbox.scrollTop = chatbox.scrollHeight;
                                        }




                                        const smtpprompt = `>TASK: if someone asks you anything, your task is to extract the user's name, email, phone number, the subject from The User input and the Previous chatbot question, Then if the user seems like he want an rdv make a paragraphe called message that contain the subject of rdv, the timing and date of the meet, and if it is online or inplace. and if it is just a normale contact Just put the message from the user's input. all in form of a Json Like this :
                {
                "name": "xxxx",
                "email": "xxxx",
                "phone": "xxxx",
                "subject": "xxxx",
                "message": "xxxx"
                }
                
                >DATA : Here is the Previous chatbot question so you can understand more the subject and the message: ${websocketResponse}
                >DATA : The User input is : ${messageInput.value}`;

                                        messageInput.value = "";

                                        // console.log(smtpprompt);

                                        try {
                                            const res = await fetch(
                                                `https://a.picoapps.xyz/ask-ai?prompt=${encodeURIComponent(smtpprompt)}`
                                            );
                                            if (!res.ok) {
                                                throw new Error("Network response was not ok");
                                            }
                                            const d = await res.json();
                                            // console.log(d.response);

                                            const jsonStartIndex = d.response.indexOf('{');
                                            const jsonContent = d.response.substring(jsonStartIndex);
                                            const parsedData = JSON.parse(jsonContent);

                                            const name = parsedData.name;
                                            const email = parsedData.email;
                                            const phone = parsedData.phone;
                                            const subject = parsedData.subject;
                                            const message = parsedData.message;

                                            var body = '<br/> >> E-mail : ' + email + '<br/> >> Name : ' + name + '<br/> >> Phone Number : ' + phone + '<br/><br/>------------------------------------------------------------------------------------<br/> subject : ' + subject + '<br/>------------------------------------------------------------------------------------<br/><br/>' + message + '<br/> <br/> <br/> <br/> <br/> ';



                                            //MY SMTP API CALL CODE

                                            const isHtml = true;
                                            const response = await fetch('https://mail-api-eight.vercel.app/api/send-email', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify({
                                                    to: companyemail,
                                                    cc: companyemailcc,
                                                    subject: subject,
                                                    message: body,
                                                    isHtml: isHtml
                                                })
                                            });

                                            const result = await response.json();

                                            if (response.ok) {
                                                //alert('Email sent successfully!');
                                                const messageElement = createMessageElement(`Your Request was sent successfully to ${company} Team, Thank you For your time, and feel free to ask me anything else you need, ${chatbotname} always at your service`, "left");
                                                chatbox.appendChild(messageElement);
                                                chatbox.scrollTop = chatbox.scrollHeight;
                                            } else {
                                                //alert('Failed to send email: ' + result.error);
                                                const messageElement = createMessageElement("Your Request was Not Sent, Please try again later!", "left");
                                                chatbox.appendChild(messageElement);
                                                chatbox.scrollTop = chatbox.scrollHeight;
                                            }



                                        } catch (error) {
                                            console.error("Error:", error);
                                        }


                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error("Error:", error);
                }
            });








            function toggleChat() {
                const chatContainer = document.getElementById('chat-container');
                const chatIcon = document.getElementById('chat-icon');

                // console.log(srcB);
                // console.log(srcX);

                if (chatContainer.style.display === 'none' || chatContainer.style.display === '') {
                    chatContainer.style.display = 'block';
                    chatIcon.src = srcX; // Close icon
                } else {
                    chatContainer.style.display = 'none';
                    chatIcon.src = srcB; // Chat icon
                }
            }


            // .catch(error =>{ console.error('Error fetching JSON data:', error);
            // alert('Error fetching data.json!!! check the file name and root, it should be data.json or go build a new one on https://botin.surge.sh/chatbotmaker');

            //   });


            document.getElementById("chatbot-bubble").addEventListener("click", () => {
                toggleChat();
            });



        }


    </script>

</html>


